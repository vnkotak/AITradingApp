name: Scan 1m

on:
  schedule:
    # Market hours: 9:15 AM - 3:30 PM IST = 3:45 AM - 10:00 AM UTC (Monday-Friday)
    # Every 8 minutes during market hours
    - cron: '45,53 3 * * 1-5'  # 3:45, 3:53 UTC (Mon-Fri)
    - cron: '1,9,17,25,33,41,49,57 4 * * 1-5'  # 4:01,4:09,4:17,4:25,4:33,4:41,4:49,4:57 UTC (Mon-Fri)
    - cron: '5,13,21,29,37,45,53 5 * * 1-5'  # 5:05,5:13,5:21,5:29,5:37,5:45,5:53 UTC (Mon-Fri)
    - cron: '1,9,17,25,33,41,49,57 6 * * 1-5'  # 6:01,6:09,6:17,6:25,6:33,6:41,6:49,6:57 UTC (Mon-Fri)
    - cron: '5,13,21,29,37,45,53 7 * * 1-5'  # 7:05,7:13,7:21,7:29,7:37,7:45,7:53 UTC (Mon-Fri)
    - cron: '1,9,17,25,33,41,49,57 8 * * 1-5'  # 8:01,8:09,8:17,8:25,8:33,8:41,8:49,8:57 UTC (Mon-Fri)
    - cron: '5,13,21,29,37,45,53 9 * * 1-5'  # 9:05,9:13,9:21,9:29,9:37,9:45,9:53 UTC (Mon-Fri)
    - cron: '1,9,17,25,33,41,49,57 10 * * 1-5' # 10:01,10:09,10:17,10:25,10:33,10:41,10:49,10:57 UTC (Mon-Fri)
  workflow_dispatch:

jobs:
  run-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Check market hours and holidays
        id: market-check
        run: |
          # Get current UTC time
          UTC_HOUR=$(date -u +%H)
          UTC_MIN=$(date -u +%M)
          DAY_OF_WEEK=$(date -u +%u)  # 1=Monday, 7=Sunday

          # Convert to IST (UTC + 5:30)
          IST_HOUR=$(( (UTC_HOUR + 5) % 24 ))
          IST_MIN=$(( UTC_MIN + 30 ))

          # Handle minute overflow
          if [ $IST_MIN -ge 60 ]; then
            IST_MIN=$(( IST_MIN - 60 ))
            IST_HOUR=$(( (IST_HOUR + 1) % 24 ))
          fi

          echo "Current UTC: $(date -u +'%Y-%m-%d %H:%M:%S')"
          echo "Current IST: $(printf "%02d:%02d" $IST_HOUR $IST_MIN)"
          echo "Day of week: $DAY_OF_WEEK (1=Monday, 7=Sunday)"

          # Check if it's a weekday (1-5 = Monday-Friday)
          if [ "$DAY_OF_WEEK" -lt 1 ] || [ "$DAY_OF_WEEK" -gt 5 ]; then
            echo "⚠️ Weekend detected. Skipping scan."
            echo "market_open=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if within market hours (IST 9:15 AM - 3:30 PM)
          if [ "$IST_HOUR" -lt 9 ] || [ "$IST_HOUR" -gt 15 ]; then
            if [ "$IST_HOUR" -eq 9 ] && [ "$IST_MIN" -lt 15 ]; then
              echo "⚠️ Before market opens (9:15 AM IST). Skipping scan."
              echo "market_open=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            if [ "$IST_HOUR" -eq 15 ] && [ "$IST_MIN" -gt 30 ]; then
              echo "⚠️ After market closes (3:30 PM IST). Skipping scan."
              echo "market_open=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            echo "⚠️ Outside market hours. Skipping scan."
            echo "market_open=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "✅ Market is open. Proceeding with scan."
          echo "market_open=true" >> $GITHUB_OUTPUT

      - name: Call scanner 1m
        if: steps.market-check.outputs.market_open == 'true'
        run: |
           # curl -sS -X POST "https://aitradingapp.onrender.com/scanner/run?mode=1m"